
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 東京苗場滑雪之旅</title>
    <!-- 外部函式庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #F8FAFC;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            color: #1e293b;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        [v-cloak] { display: none; }
        
        .sortable-ghost { opacity: 0.2; background: #dbeafe !important; border: 2px dashed #3b82f6 !important; border-radius: 40px; }
        .sortable-drag { opacity: 0.95; transform: scale(1.02); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }

        .banner-gradient {
            background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 60%, rgba(248,250,252,1) 100%);
        }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative bg-[#F8FAFC] pb-24 shadow-2xl border-x border-slate-100">
        
        <!-- 頁首 Banner -->
        <!-- 修改：恢復大尺寸，靠右位移 (ml-auto, w-[95%])，圖片靠左不置中 (object-left) -->
        <div class="h-[380px] relative w-full overflow-hidden bg-[#F8FAFC] pt-4">
            <div class="w-[95%] h-full ml-auto relative shadow-2xl rounded-l-[48px] overflow-hidden transform transition-transform hover:scale-[1.01] duration-500">
                <img src="banner.jpg" @error="handleBannerError" 
                     class="w-full h-full object-cover object-left">
                <div class="absolute inset-0 bg-black/10"></div>
                
                <!-- Banner 文字 -->
                <div class="absolute top-12 left-8 pointer-events-none">
                    <h1 class="text-white text-4xl font-black drop-shadow-2xl tracking-tighter">TOKYO 2026</h1>
                    <p class="text-white/90 text-sm font-bold tracking-[0.2em] uppercase mt-1">Ski & City Adventure</p>
                </div>
            </div>

            <!-- Tab 導航 -->
            <div class="absolute bottom-10 right-6 flex items-center gap-3">
                <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
                        :class="['w-14 h-14 rounded-2xl flex items-center justify-center shadow-xl transition-all duration-300 backdrop-blur-sm', 
                                activeTab === tab.id ? 'bg-blue-600 text-white scale-110 z-10' : 'bg-white/90 text-blue-500 hover:bg-white']">
                    <i :data-lucide="tab.icon" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <!-- 主要內容區域 -->
        <div class="mt-[-30px] relative z-20 bg-[#F8FAFC] rounded-t-[50px] px-6 pt-10 min-h-[500px]">
            
            <!-- 1. 行程分頁 -->
            <div v-if="activeTab === 'itinerary'" class="space-y-6 animate-slide-up">
                <!-- 日期選擇器 -->
                <div class="flex gap-4 overflow-x-auto hide-scrollbar pb-2">
                    <button v-for="date in dates" :key="date" @click="selectedDate = date"
                            :class="['flex flex-col items-center min-w-[72px] py-5 rounded-[32px] transition-all duration-300 border',
                                    selectedDate === date ? 'bg-blue-600 text-white shadow-xl scale-105 border-blue-600' : 'bg-white text-slate-400 border-slate-100']">
                        <span class="text-[10px] font-black uppercase mb-1 tracking-widest">{{ dayLabels[date] }}</span>
                        <span class="text-2xl font-black">{{ date.split('/')[1] }}</span>
                    </button>
                </div>

                <!-- 每日餐食概覽 -->
                <div class="grid grid-cols-3 gap-3">
                    <div v-for="food in ['早餐', '午餐', '晚餐']" :key="food" 
                         class="bg-white rounded-[32px] p-4 border border-slate-50 shadow-sm flex flex-col items-center justify-center gap-2 transition-all relative group">
                        
                        <div @click="openFoodEdit(food)" class="flex flex-col items-center gap-2 cursor-pointer w-full active:scale-95 transition-transform">
                            <div :class="['p-3 rounded-2xl transition-colors', getFoodItem(food) ? 'bg-orange-50 text-orange-500' : 'bg-slate-50 text-slate-300']">
                                <i :data-lucide="getFoodIcon(food)" class="w-5 h-5"></i>
                            </div>
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">{{ food }}</span>
                            <p class="text-[11px] font-bold text-slate-600 truncate w-full text-center px-1" v-if="getFoodItem(food)">
                                {{ getFoodItem(food).name }}
                            </p>
                            <p class="text-[10px] font-bold text-slate-300" v-else>未安排</p>
                        </div>
                        
                        <button v-if="getFoodItem(food)" @click.stop="navigate(getFoodItem(food).name)"
                                class="absolute top-2 right-2 p-1.5 bg-orange-50/80 text-orange-500 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <i data-lucide="navigation" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>

                <!-- 行程清單 (SortableJS) -->
                <div id="itinerary-list" class="space-y-6 pb-24">
                    <div v-for="(item, idx) in currentItinerary" :key="item.id" :data-id="item.id" class="itinerary-card group">
                        <div @click="openEdit(item)"
                             :class="['p-7 rounded-[40px] shadow-sm border transition-all relative active:scale-[0.98] cursor-pointer',
                                     item.category === '航班' ? 'bg-gradient-to-br from-blue-600 to-indigo-600 text-white border-none' : 'bg-white border-slate-100']">
                            
                            <div class="drag-handle absolute top-7 right-7 p-2 opacity-20 hover:opacity-100 transition-opacity">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </div>

                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center gap-2">
                                    <span :class="['text-[10px] px-3 py-1.5 rounded-full font-black uppercase tracking-widest', 
                                                item.category === '航班' ? 'bg-white/20 text-white' : (item.category === '美食' ? 'bg-orange-50 text-orange-500' : 'bg-blue-50 text-blue-500')]">
                                        {{ item.category }}
                                    </span>
                                    <span v-if="item.time" class="text-xs font-black opacity-60">{{ item.time }}</span>
                                </div>
                                <button @click.stop="navigate(item.name)" class="p-2.5 rounded-full mr-10" :class="item.category === '航班' ? 'bg-white/20' : 'bg-blue-50 text-blue-500 hover:bg-blue-100'">
                                    <i data-lucide="navigation" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <h3 class="text-xl font-black leading-tight mb-3 pr-10">{{ item.name }}</h3>
                            <p class="text-xs font-medium opacity-70 leading-relaxed">{{ item.notes }}</p>
                        </div>

                        <!-- 交通間隔 (使用 Lucide Icons) -->
                        <div v-if="idx < currentItinerary.length - 1" class="flex flex-col items-center my-4 pointer-events-none">
                            <div class="w-[2px] h-6 bg-slate-100"></div>
                            <div class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-3xl border border-slate-50 shadow-sm text-[11px] font-black text-slate-500">
                                <!-- 動態圖示 -->
                                <i :data-lucide="getTransportIcon(item.transportToNext?.type)" class="w-4 h-4 text-blue-500"></i>
                                <span>{{ item.transportToNext?.duration || '計算中...' }}</span>
                            </div>
                            <div class="w-[2px] h-6 bg-slate-100"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 資訊分頁 (Info) -->
            <div v-else-if="activeTab === 'info'" class="space-y-10 pb-10 animate-slide-up">
                
                <!-- 匯率 -->
                <section class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-100">
                    <h3 class="font-black text-slate-800 flex items-center gap-2 text-xl mb-8"><i data-lucide="calculator" class="w-6 h-6 text-blue-500"></i> 匯率換算</h3>
                    <div class="flex items-center gap-6">
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-slate-400 block mb-2 px-1">日幣 JPY</label>
                            <input type="number" v-model="jpyInput" class="w-full bg-slate-50 rounded-3xl p-5 font-black outline-none border-none text-2xl">
                        </div>
                        <i data-lucide="arrow-right" class="text-blue-100 mt-6"></i>
                        <div class="flex-1">
                            <label class="text-[10px] font-black text-slate-400 block mb-2 px-1">台幣 TWD (0.21)</label>
                            <div class="p-5 bg-blue-50 rounded-3xl font-black text-blue-600 text-2xl border border-blue-100 truncate">
                                {{ (jpyInput * 0.21).toFixed(0) }}
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- 航班資訊 -->
                <section class="space-y-6">
                    <h3 class="font-black text-slate-800 flex items-center gap-2 text-xl px-2"><i data-lucide="plane" class="w-6 h-6 text-blue-500"></i> 航班資訊</h3>
                    <div v-for="f in flightDetails" :key="f.flightNo" class="bg-white rounded-[40px] shadow-sm border border-slate-100 p-8">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full">{{ f.type === 'DEPARTURE' ? '去程' : '回程' }}</span>
                            <span class="text-[11px] font-black text-slate-400 uppercase tracking-widest">{{ f.airline }} | {{ f.flightNo }}</span>
                        </div>
                        <div class="flex items-center justify-between gap-4 text-center">
                            <div><p class="text-3xl font-black text-slate-800">{{ f.depTime }}</p><p class="text-[11px] font-bold text-slate-400 mt-1">{{ f.depCity }}</p></div>
                            <div class="flex-1 border-t-2 border-slate-100 relative">
                                <i data-lucide="plane" class="w-4 h-4 text-blue-200 absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white px-2"></i>
                                <p class="absolute -top-6 left-1/2 -translate-x-1/2 text-[9px] font-black text-slate-300 w-full">{{ f.duration }}</p>
                            </div>
                            <div><p class="text-3xl font-black text-slate-800">{{ f.arrTime }}</p><p class="text-[11px] font-bold text-slate-400 mt-1">{{ f.arrCity }}</p></div>
                        </div>
                    </div>
                </section>

                <!-- 住宿資訊 -->
                <section class="space-y-6">
                    <h3 class="font-black text-slate-800 flex items-center gap-2 text-xl px-2"><i data-lucide="bed" class="w-6 h-6 text-blue-500"></i> 住宿資訊</h3>
                    <div v-for="stay in accommodations" :key="stay.id" class="bg-white rounded-[40px] shadow-sm border border-slate-100 p-8 space-y-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-xl font-black text-slate-800 leading-tight mb-1">{{ stay.name }}</h4>
                                <p class="text-[10px] font-black text-blue-500 bg-blue-50 inline-block px-2 py-0.5 rounded-lg">{{ stay.dates }}</p>
                            </div>
                        </div>
                        <div class="space-y-3 pt-2">
                            <div class="flex items-center gap-4 text-slate-600">
                                <i data-lucide="phone" class="w-4 h-4 text-slate-300"></i>
                                <a :href="'tel:' + stay.phone" class="text-sm font-bold hover:text-blue-600 transition-colors">{{ stay.phone }}</a>
                            </div>
                            <div class="flex items-start gap-4 text-slate-600">
                                <i data-lucide="map-pin" class="w-4 h-4 text-slate-300 mt-1"></i>
                                <p class="text-sm font-medium flex-1">{{ stay.address }}</p>
                            </div>
                            <!-- 導航按鈕 -->
                            <button @click="navigate(stay.name)" class="w-full mt-2 py-4 bg-slate-50 text-blue-600 rounded-3xl font-black text-sm flex items-center justify-center gap-2 hover:bg-blue-50 transition-colors">
                                <i data-lucide="navigation" class="w-4 h-4"></i>
                                導航前往
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 3. 購物分頁 -->
            <div v-else-if="activeTab === 'shopping'" class="space-y-5 pb-10 animate-slide-up">
                <div v-if="shoppingList.length > 0" class="w-full">
                    <div v-for="item in shoppingList" :key="item.id" @click="openShoppingEdit(item)"
                         class="bg-white rounded-[40px] p-5 flex gap-5 shadow-sm border border-slate-100 active:scale-[0.97] transition-all mb-4">
                        <div class="w-24 h-24 bg-slate-50 rounded-[32px] flex items-center justify-center border border-slate-100">
                            <i data-lucide="package" class="w-8 h-8 text-slate-200"></i>
                        </div>
                        <div class="flex-1 py-1 flex flex-col justify-between overflow-hidden">
                            <div>
                                <h4 class="font-black text-slate-800 truncate mb-1 text-lg">{{ item.name }}</h4>
                                <p class="text-[12px] text-slate-400 line-clamp-2 leading-relaxed">{{ item.notes || '點擊編輯商品備註' }}</p>
                            </div>
                            <div class="flex justify-end"><span class="text-[10px] font-black text-blue-500 bg-blue-50 px-3 py-1.5 rounded-xl">編輯</span></div>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-20">
                    <div class="bg-slate-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-300">
                        <i data-lucide="shopping-cart" class="w-10 h-10"></i>
                    </div>
                    <p class="text-slate-400 font-bold">目前購物清單是空的</p>
                    <p class="text-xs text-slate-300 font-bold mt-2">點擊右下角 + 新增商品</p>
                </div>
            </div>

            <!-- 4. 花費分頁 -->
            <div v-else-if="activeTab === 'expenses'" class="space-y-8 pb-10 animate-slide-up">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-800 rounded-[50px] p-12 text-white shadow-2xl relative overflow-hidden">
                    <p class="text-[11px] font-black uppercase tracking-[0.4em] mb-3 opacity-60">預估旅程總額</p>
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-bold opacity-60">¥</span>
                        <h2 class="text-6xl font-black">125,000</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAB -->
        <button v-if="activeTab === 'itinerary' || activeTab === 'shopping'" @click="handleFABClick" 
                class="fixed bottom-10 right-10 w-16 h-16 bg-blue-600 rounded-[28px] flex items-center justify-center text-white shadow-2xl z-[999] active:scale-90 transition-transform hover:bg-blue-700">
            <i data-lucide="plus" class="w-9 h-9 stroke-[3]"></i>
        </button>

        <!-- 編輯彈窗 -->
        <div v-if="modal.show" class="fixed inset-0 z-[1000] flex items-end justify-center bg-slate-900/60 backdrop-blur-md p-4" @click.self="modal.show = false">
            <div class="bg-white w-full max-w-md rounded-t-[56px] p-10 shadow-2xl animate-slide-up max-h-[92vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black text-slate-800">{{ modal.title }}</h2>
                    <button @click="modal.show = false" class="p-3 bg-slate-100 rounded-full text-slate-400 hover:text-slate-600">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                
                <div class="space-y-8">
                    <div v-if="!modal.isShopping" class="space-y-6">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">名稱</label>
                            <input v-model="modal.form.name" type="text" class="w-full bg-slate-50 rounded-3xl p-5 font-bold outline-none border-none text-lg">
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1 space-y-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">類別</label>
                                <select v-model="modal.form.category" class="w-full bg-slate-50 rounded-3xl p-5 font-bold border-none">
                                    <option>景點</option><option>住宿</option><option>美食</option><option>航班</option><option>交通</option>
                                </select>
                            </div>
                            <div class="flex-1 space-y-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">時間</label>
                                <input v-model="modal.form.time" type="text" class="w-full bg-slate-50 rounded-3xl p-5 font-bold border-none" placeholder="HH:MM">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">詳細備註</label>
                            <textarea v-model="modal.form.notes" class="w-full bg-slate-50 rounded-3xl p-5 font-medium h-36 outline-none border-none leading-relaxed"></textarea>
                        </div>
                    </div>

                    <div v-else class="space-y-6">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">商品名稱</label>
                            <input v-model="modal.form.name" type="text" class="w-full bg-slate-50 rounded-3xl p-5 font-bold border-none text-lg">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest px-1">備註</label>
                            <textarea v-model="modal.form.notes" class="w-full bg-slate-50 rounded-3xl p-5 font-medium h-24 border-none"></textarea>
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4 pb-4">
                        <button v-if="modal.isEdit" @click="handleDelete" 
                                class="flex-1 py-5 bg-red-50 text-red-500 font-black rounded-[28px] text-xs uppercase hover:bg-red-100">
                            刪除
                        </button>
                        <button @click="handleSave" class="flex-[3] bg-blue-600 text-white font-black py-5 rounded-[28px] shadow-2xl active:scale-95 transition-transform">
                            {{ modal.isEdit ? '儲存' : '新增' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDate = ref('1/26');
                const jpyInput = ref(1000);
                const weather = ref({ temp: '--', label: '取得中...', location: '' });
                let sortableInstance = null;

                const tabs = [
                    { id: 'itinerary', icon: 'map-pin' },
                    { id: 'info', icon: 'info' },
                    { id: 'shopping', icon: 'shopping-basket' },
                    { id: 'expenses', icon: 'wallet' }
                ];

                const dates = ['1/26', '1/27', '1/28', '1/29', '1/30', '1/31'];
                const dayLabels = { '1/26': 'SUN', '1/27': 'MON', '1/28': 'TUE', '1/29': 'WED', '1/30': 'THU', '1/31': 'FRI' };

                const flightDetails = [
                    { type: 'DEPARTURE', airline: '星宇航空', flightNo: 'JX802', depCity: 'TPE (T1)', depTime: '10:10', arrCity: 'NRT (T2)', arrTime: '14:20', duration: '3h 10m' },
                    { type: 'RETURN', airline: '星宇航空', flightNo: 'JX805', depCity: 'NRT (T2)', depTime: '20:10', arrCity: 'TPE (T1)', arrTime: '23:20', duration: '4h 10m' }
                ];

                const accommodations = [
                    { id: 'stay1', name: 'Hop Inn Asakusa', phone: '+81 3-5830-8041', address: '台東區淺草2-26-10', dates: '1/26 - 1/27' },
                    { id: 'stay2', name: '苗場王子飯店', phone: '+81 25-789-2211', address: '新潟縣南魚沼郡湯澤町三國', dates: '1/28 - 1/30' }
                ];

                const itineraries = ref({
                    '1/26': [
                        { id: '1-1', name: '星宇航空 JX802', category: '航班', time: '10:10', notes: '台北 T1 出發 -> 14:20 成田 T2 抵達', transportToNext: { type: 'TRANSIT', duration: '前往 B1' } },
                        { id: '1-2', name: 'JR 綠色窗口', category: '交通', notes: '換 Suica 並儲值 (成田機場)', transportToNext: { type: 'TRANSIT', duration: '45 min' } },
                        { id: '1-3', name: 'Skyliner (前往上野)', category: '交通', notes: '搭乘特急前往上野站', transportToNext: { type: 'TRANSIT', duration: '15 min' } },
                        { id: '1-4', name: '銀座線 (前往淺草)', category: '交通', notes: '轉乘至淺草站 (二番線，1號出口有電梯)', transportToNext: { type: 'WALK', duration: '5 min' } },
                        { id: '1-5', name: '領取地鐵一日券', category: '交通', notes: '車站自動售票機領取', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '1-6', name: 'HOP INN 淺草', category: '住宿', time: '16:00', notes: 'Check-in (預計 16:00-17:00)', transportToNext: { type: 'WALK', duration: '5 min' } },
                        { id: '1-7', name: 'UNIQLO 淺草店', category: '購物', notes: '10:00-20:00 (台東區淺草2-6-7)', transportToNext: { type: 'WALK', duration: '5 min' } },
                        { id: '1-8', name: 'MUJI 淺草 ROX', category: '購物', notes: '10:30-21:00 (ROX 3F)', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '1-9', name: '一蘭拉麵 淺草店', category: '美食', notes: '晚餐 (10:00-23:00)', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '1-10', name: '淺草寺夜拍', category: '景點', notes: 'Lawson 買消夜與隔日早餐' }
                    ],
                    '1/27': [
                        { id: '2-1', name: '前往東京站', category: '交通', time: '09:30', notes: '搭乘銀座線 (約30-40分)', transportToNext: { type: 'TRANSIT', duration: '40 min' } },
                        { id: '2-2', name: 'Gransta & 一番街', category: '購物', time: '10:00', notes: '逛角色商店、伴手禮與甜點', transportToNext: { type: 'WALK', duration: '5 min' } },
                        { id: '2-3', name: '東京站午餐', category: '美食', notes: '享用午餐', transportToNext: { type: 'TRANSIT', duration: '20 min' } },
                        { id: '2-4', name: '前往東京鐵塔', category: '交通', time: '13:00', notes: '出發前往東京鐵塔', transportToNext: { type: 'TRANSIT', duration: '30 min' } },
                        { id: '2-5', name: '東京鐵塔 & RED°', category: '景點', time: '15:00', notes: '登塔遊覽 (15:00-18:00)', transportToNext: { type: 'TRANSIT', duration: '40 min' } },
                        { id: '2-6', name: '返回淺草晚餐', category: '美食', time: '19:00', notes: '搭地鐵回淺草晚餐', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '2-7', name: '採買雪場物資', category: '購物', notes: '買好 3早餐、2午餐、3晚餐' }
                    ],
                    '1/28': [
                        { id: '3-1', name: '退房 & 前往上野', category: '交通', time: '08:00', notes: '銀座線淺草站 (2番線1號出口電梯)', transportToNext: { type: 'TRANSIT', duration: '20 min' } },
                        { id: '3-2', name: '上越新幹線', category: '交通', time: '09:58', notes: '上野 -> 越後湯澤 (09:58-11:11)', transportToNext: { type: 'SHINKANSEN', duration: '73 min' } },
                        { id: '3-3', name: '越後湯澤站', category: '景點', time: '11:11', notes: '寄行李、中野屋抽號碼牌、逛車站', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '3-4', name: '中野屋 嘿奇蕎麥', category: '美食', time: '11:30', notes: '享用午餐', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '3-5', name: '飯店接駁巴士', category: '交通', time: '14:10', notes: '前往苗場 (約40-50分)', transportToNext: { type: 'CAR', duration: '50 min' } },
                        { id: '3-6', name: '苗場王子飯店 4號館', category: '住宿', time: '15:30', notes: 'Check-in, 填寫裝備單', transportToNext: { type: 'WALK', duration: '5 min' } },
                        { id: '3-7', name: '美食街晚餐', category: '美食', notes: '飯店內享用' }
                    ],
                    '1/29': [
                        { id: '4-1', name: '苗場滑雪趣 (Day 1)', category: '景點', notes: '全天滑雪行程' }
                    ],
                    '1/30': [
                        { id: '5-1', name: '苗場滑雪趣 (Day 2)', category: '景點', notes: '全天滑雪行程' }
                    ],
                    '1/31': [
                        { id: '6-1', name: '飯店接駁車', category: '交通', time: '10:15', notes: '前往越後湯澤站', transportToNext: { type: 'CAR', duration: '50 min' } },
                        { id: '6-2', name: 'Tonkatsu Ninjintei', category: '美食', time: '12:00', notes: '人參亭炸豬排午餐', transportToNext: { type: 'WALK', duration: '10 min' } },
                        { id: '6-3', name: '上越新幹線', category: '交通', time: '14:31', notes: '越後湯澤 -> 上野 (14:31-15:38)', transportToNext: { type: 'SHINKANSEN', duration: '67 min' } },
                        { id: '6-4', name: 'Skyliner', category: '交通', time: '16:20', notes: '上野 -> 成田機場 T2', transportToNext: { type: 'TRANSIT', duration: '45 min' } },
                        { id: '6-5', name: '星宇航空 JX805', category: '航班', time: '20:10', notes: '成田 T2 -> 台北 T1 (23:20抵達)' }
                    ]
                });

                const shoppingList = ref([]);
                const modal = ref({ show: false, title: '', isEdit: false, isShopping: false, form: {} });

                const currentItinerary = computed(() => itineraries.value[selectedDate.value] || []);
                const currentWeatherIcon = computed(() => 'sun');

                // 模擬交通時間計算
                const recalcTransport = (day) => {
                    const items = itineraries.value[day];
                    if (!items) return;
                    items.forEach((item, index) => {
                        if (index < items.length - 1) {
                            // 簡單規則：如果沒有設定，則隨機分配一個交通方式
                            if (!item.transportToNext) {
                                const types = ['WALK', 'TRANSIT', 'CAR'];
                                const randomType = types[Math.floor(Math.random() * types.length)];
                                const randomTime = Math.floor(Math.random() * 30) + 5;
                                item.transportToNext = { type: randomType, duration: `${randomTime} min` };
                            }
                        }
                    });
                };

                const getTransportIcon = (type) => {
                    switch (type) {
                        case 'WALK': return 'footprints';
                        case 'CAR': return 'car';
                        case 'SHINKANSEN': return 'train-front'; // 新幹線用火車圖示
                        default: return 'bus'; // 預設大眾運輸
                    }
                };

                const getFoodItem = (type) => {
                    return currentItinerary.value.find(item => 
                        (item.category === '美食' || item.notes?.includes(type) || item.name?.includes(type)) &&
                        (item.name?.includes(type) || item.notes?.includes(type))
                    );
                };

                const getFoodIcon = (type) => type === '早餐' ? 'coffee' : (type === '午餐' ? 'utensils' : 'moon');

                const openFoodEdit = (type) => {
                    const item = getFoodItem(type);
                    if (item) openEdit(item);
                    else {
                        modal.value = { show: true, title: `安排${type}`, isEdit: false, isShopping: false, form: { name: '', notes: `${type}筆記`, category: '美食', time: '' } };
                        nextTick(() => lucide.createIcons());
                    }
                };

                const handleFABClick = () => {
                    if (activeTab.value === 'shopping') {
                        modal.value = { show: true, title: '新增商品', isEdit: false, isShopping: true, form: { name: '', notes: '' } };
                    } else if (activeTab.value === 'itinerary') {
                        modal.value = { show: true, title: '新增行程', isEdit: false, isShopping: false, form: { name: '', notes: '', category: '景點', time: '' } };
                    }
                    nextTick(() => lucide.createIcons());
                };

                const openEdit = (item) => { 
                    modal.value = { show: true, title: '編輯項目', isEdit: true, isShopping: false, form: { ...item } }; 
                    nextTick(() => lucide.createIcons()); 
                };

                const openShoppingEdit = (item) => {
                    modal.value = { show: true, title: '編輯商品', isEdit: true, isShopping: true, form: { ...item } };
                    nextTick(() => lucide.createIcons());
                };

                const handleSave = () => {
                    if (modal.value.isShopping) {
                        if (modal.value.isEdit) {
                            const idx = shoppingList.value.findIndex(i => i.id === modal.value.form.id);
                            shoppingList.value[idx] = { ...modal.value.form };
                        } else {
                            shoppingList.value.push({ ...modal.value.form, id: Date.now() });
                        }
                    } else {
                        const day = selectedDate.value;
                        if (modal.value.isEdit) {
                            const idx = itineraries.value[day].findIndex(i => i.id === modal.value.form.id);
                            itineraries.value[day][idx] = { ...modal.value.form };
                        } else {
                            if (!itineraries.value[day]) itineraries.value[day] = [];
                            itineraries.value[day].push({ ...modal.value.form, id: Date.now() });
                        }
                        recalcTransport(day); // 重新計算交通
                    }
                    modal.value.show = false;
                    nextTick(() => lucide.createIcons());
                };

                const handleDelete = () => {
                    if (!confirm('確定要永久刪除此項目嗎？')) return;
                    if (modal.value.isShopping) {
                        shoppingList.value = shoppingList.value.filter(i => i.id !== modal.value.form.id);
                    } else {
                        const day = selectedDate.value;
                        itineraries.value[day] = itineraries.value[day].filter(i => i.id !== modal.value.form.id);
                        recalcTransport(day);
                    }
                    modal.value.show = false;
                    nextTick(() => lucide.createIcons());
                };

                const navigate = (name) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank');
                const handleBannerError = (e) => e.target.src = 'https://images.unsplash.com/photo-1540959733332-e94e1bfba1fa?w=1200';

                const initSortable = () => {
                    const el = document.getElementById('itinerary-list');
                    if (!el || activeTab.value !== 'itinerary') return;
                    if (sortableInstance) sortableInstance.destroy();
                    sortableInstance = new Sortable(el, {
                        animation: 150, handle: '.drag-handle',
                        onEnd: (evt) => {
                            const day = selectedDate.value;
                            const items = [...itineraries.value[day]];
                            const [movedItem] = items.splice(evt.oldIndex, 1);
                            items.splice(evt.newIndex, 0, movedItem);
                            itineraries.value[day] = items;
                            recalcTransport(day); // 拖曳後重新計算
                            nextTick(() => lucide.createIcons());
                        }
                    });
                };

                watch([selectedDate, activeTab], () => {
                    nextTick(() => { lucide.createIcons(); initSortable(); });
                });

                onMounted(() => { lucide.createIcons(); initSortable(); });

                return { 
                    activeTab, selectedDate, tabs, dates, dayLabels, itineraries, shoppingList, 
                    weather, currentWeatherIcon, currentItinerary, modal, jpyInput, flightDetails,
                    handleBannerError, openEdit, openShoppingEdit, handleSave, handleDelete, 
                    handleFABClick, navigate, getTransportIcon, getFoodItem, getFoodIcon, openFoodEdit,
                    accommodations
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
