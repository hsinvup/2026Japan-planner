
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 東京苗場滑雪之旅</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #F0F7FF;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            color: #1e293b;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        [v-cloak] { display: none; }
        
        /* 拖曳樣式 */
        .sortable-ghost {
            opacity: 0.2;
            background: #cbd5e1 !important;
            border: 2px dashed #3b82f6 !important;
        }
        .sortable-drag {
            opacity: 0.9;
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .drag-handle {
            cursor: grab;
            touch-action: none;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-slow { animation: bounce-slow 4s infinite ease-in-out; }

        .banner-placeholder {
            background: linear-gradient(135deg, #60a5fa, #2563eb);
        }

        .tab-transition-enter-active, .tab-transition-leave-active {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .tab-transition-enter-from { opacity: 0; transform: translateY(10px); }
        .tab-transition-leave-to { opacity: 0; transform: translateY(-10px); }
    </style>
</head>
<body>
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen relative bg-[#F0F7FF] pb-24 shadow-2xl">
        
        <!-- 頁首 Banner -->
        <div class="h-[260px] relative w-full overflow-hidden shadow-inner banner-placeholder">
            <img :src="bannerSrc" 
                 @error="handleBannerError"
                 alt="Travel Banner" 
                 class="w-full h-full object-cover transition-opacity duration-1000">
            <div class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-[#F0F7FF]"></div>
            
            <div class="absolute top-8 left-6">
                <h1 class="text-white text-2xl font-black drop-shadow-lg tracking-wider">TOKYO 2026</h1>
                <p class="text-white/80 text-xs font-bold tracking-[0.2em] uppercase">Ski & City Trip</p>
            </div>

            <!-- 頁籤導覽 -->
            <div class="absolute bottom-14 right-6 flex items-center gap-3">
                <button v-for="tab in tabs" :key="tab.id"
                        @click="activeTab = tab.id"
                        :class="['w-12 h-12 rounded-[20px] flex items-center justify-center shadow-xl transition-all duration-500', 
                                activeTab === tab.id ? 'bg-blue-600 text-white scale-110 shadow-blue-300' : 'bg-white text-blue-500 hover:bg-blue-50']">
                    <i :data-lucide="tab.icon" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- 主要內容 -->
        <div class="mt-[-40px] relative z-20 bg-[#F0F7FF] rounded-t-[48px] px-6 pt-10">
            
            <transition name="tab-transition" mode="out-in">
                <!-- 1. 行程分頁 -->
                <div v-if="activeTab === 'itinerary'" key="itinerary" class="space-y-6">
                    <!-- 日期選擇 -->
                    <div class="flex gap-4 overflow-x-auto hide-scrollbar pb-2">
                        <button v-for="date in dates" :key="date"
                                @click="selectedDate = date"
                                :class="['flex flex-col items-center min-w-[70px] py-4 rounded-[28px] transition-all duration-300 border',
                                        selectedDate === date ? 'bg-blue-600 text-white shadow-xl scale-105 border-blue-600' : 'bg-white text-slate-400 border-slate-100']">
                            <span class="text-[10px] font-black uppercase mb-1 tracking-widest opacity-80">{{ dayLabels[date] }}</span>
                            <span class="text-xl font-black">{{ date.split('/')[1] }}</span>
                        </button>
                    </div>

                    <!-- 座標天氣資訊 -->
                    <div class="bg-white/80 backdrop-blur-lg rounded-[32px] p-6 flex items-center justify-between shadow-sm border border-white/50">
                        <div class="flex items-center gap-4">
                            <div class="bg-blue-100/50 p-4 rounded-2xl text-blue-600">
                                <i :data-lucide="weatherIcon" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <p class="text-[10px] text-blue-500 font-black tracking-widest uppercase mb-1">
                                    {{ weatherLoading ? '正在取得定位氣溫...' : (weather.location || '目前地點氣溫') }}
                                </p>
                                <div v-if="!weatherLoading" class="flex items-baseline gap-2">
                                    <p class="text-3xl font-black text-slate-800">{{ weather.temp }}°C</p>
                                    <span class="text-sm font-bold text-slate-400">{{ weather.label }}</span>
                                </div>
                                <div v-else class="h-8 w-24 bg-slate-100 animate-pulse rounded-lg"></div>
                            </div>
                        </div>
                        <div class="text-right" v-if="!weatherLoading">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Updated {{ weather.time }}</p>
                            <button @click="fetchWeather" class="p-2 text-blue-400 hover:bg-blue-50 rounded-full transition-colors">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 行程列表 (可拖曳) -->
                    <div id="itinerary-list" class="space-y-4 min-h-[100px]">
                        <div v-for="(item, idx) in currentItinerary" :key="item.id" :data-id="item.id" class="itinerary-item group">
                            <div @click="openEdit(item)"
                                 :class="['p-6 rounded-[36px] shadow-sm border transition-all relative active:scale-[0.98] cursor-pointer',
                                         item.category === '航班' ? 'bg-gradient-to-br from-blue-600 to-indigo-600 text-white border-none shadow-blue-200' : 'bg-white border-blue-50']">
                                
                                <!-- 拖曳手柄 -->
                                <div class="drag-handle absolute top-6 right-6 p-2 opacity-20 hover:opacity-100 transition-opacity">
                                    <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                </div>

                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex items-center gap-2">
                                        <span :class="['text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-widest', 
                                                    item.category === '航班' ? 'bg-white/20 text-white' : 'bg-blue-50 text-blue-500']">
                                            {{ item.category }}
                                        </span>
                                        <span v-if="item.time" class="text-xs font-black opacity-60">{{ item.time }}</span>
                                    </div>
                                    <button @click.stop="navigate(item.name)" class="p-2 rounded-full mr-8" :class="item.category === '航班' ? 'bg-white/20' : 'bg-blue-50 text-blue-500 hover:bg-blue-100'">
                                        <i data-lucide="navigation" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <h3 class="text-lg font-black leading-tight mb-2 pr-10">{{ item.name }}</h3>
                                <p class="text-xs font-medium opacity-70 leading-relaxed line-clamp-2">{{ item.notes }}</p>
                            </div>

                            <!-- 移動間隔 -->
                            <div v-if="idx < currentItinerary.length - 1" class="flex flex-col items-center my-3 pointer-events-none">
                                <div class="w-[2px] h-4 bg-blue-100"></div>
                                <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-2xl border border-blue-50 shadow-sm text-[10px] font-black text-blue-500">
                                    <i data-lucide="clock" class="w-3 h-3"></i>
                                    <span>{{ item.transportToNext?.duration || 'Next Stop' }}</span>
                                </div>
                                <div class="w-[2px] h-4 bg-blue-100"></div>
                            </div>
                        </div>
                        <div v-if="currentItinerary.length === 0" class="py-20 text-center opacity-20 italic font-black">
                            No plans for today yet
                        </div>
                    </div>
                </div>

                <!-- 2. 資訊分頁 -->
                <div v-else-if="activeTab === 'info'" key="info" class="space-y-8 pb-10">
                    <section class="bg-white p-8 rounded-[40px] shadow-sm border border-blue-50">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-slate-800 flex items-center gap-2 text-lg"><i data-lucide="repeat" class="w-5 h-5 text-blue-500"></i> 匯率換算</h3>
                            <span class="text-[10px] font-black text-slate-300">Rate: 0.21</span>
                        </div>
                        <div class="grid grid-cols-[1fr,auto,1fr] items-center gap-4">
                            <div>
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-2">JPY</label>
                                <input type="number" v-model="jpyInput" class="w-full bg-slate-50 rounded-2xl p-4 font-black outline-none focus:ring-2 focus:ring-blue-200 text-xl">
                            </div>
                            <i data-lucide="arrow-right" class="text-blue-200 mt-6"></i>
                            <div>
                                <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-2">TWD</label>
                                <div class="p-4 bg-blue-50 rounded-2xl font-black text-blue-600 text-xl truncate border border-blue-100">
                                    {{ (jpyInput * 0.21).toFixed(0) }}
                                </div>
                            </div>
                        </div>
                    </section>

                    <section v-for="f in flightDetails" :key="f.flightNo" class="bg-white rounded-[40px] overflow-hidden shadow-sm border border-slate-100 p-8">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-4 py-1.5 rounded-full uppercase tracking-widest">{{ f.type === 'DEPARTURE' ? 'Outbound' : 'Return' }}</span>
                            <span class="text-[10px] font-black text-slate-400">{{ f.airline }} | {{ f.flightNo }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-center">
                                <p class="text-3xl font-black text-slate-800">{{ f.depTime }}</p>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ f.depCity }}</p>
                            </div>
                            <div class="flex-1 flex flex-col items-center px-6">
                                <i data-lucide="plane" class="w-5 h-5 text-blue-200 mb-2 transition-transform hover:translate-x-2"></i>
                                <div class="w-full h-[2px] bg-slate-50 relative">
                                    <div class="absolute inset-0 bg-blue-100 w-1/2 rounded-full"></div>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-black text-slate-800">{{ f.arrTime }}</p>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ f.arrCity }}</p>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- 3. 購物分頁 -->
                <div v-else-if="activeTab === 'shopping'" key="shopping" class="space-y-4 pb-10">
                    <div v-if="shoppingList.length === 0" class="py-24 text-center opacity-20 flex flex-col items-center">
                        <i data-lucide="shopping-bag" class="w-20 h-20 mb-6"></i>
                        <p class="font-black text-lg">Shopping list is empty</p>
                    </div>
                    
                    <div v-for="item in shoppingList" :key="item.id" 
                         @click="openShoppingEdit(item)"
                         class="bg-white rounded-[40px] p-5 flex gap-5 shadow-sm border border-blue-50 active:scale-95 transition-all group">
                        
                        <div class="w-28 h-28 bg-slate-50 rounded-[28px] flex-shrink-0 overflow-hidden border border-slate-100 flex items-center justify-center relative shadow-inner">
                            <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                            <i v-else data-lucide="image" class="w-8 h-8 text-slate-200"></i>
                        </div>

                        <div class="flex-1 py-1 flex flex-col justify-between overflow-hidden">
                            <div>
                                <h4 class="font-black text-slate-800 truncate mb-1 text-lg group-hover:text-blue-600 transition-colors">{{ item.name }}</h4>
                                <p class="text-xs text-slate-400 line-clamp-3 leading-relaxed">{{ item.notes || 'No notes added yet...' }}</p>
                            </div>
                            <div class="flex justify-end">
                                <span class="text-[10px] font-black text-blue-500 bg-blue-50 px-3 py-1.5 rounded-xl uppercase tracking-widest hover:bg-blue-100 transition-colors">Details</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. 花費分頁 -->
                <div v-else-if="activeTab === 'expenses'" key="expenses" class="space-y-6 pb-10">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-[48px] p-12 text-white shadow-2xl shadow-blue-200 relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                        <p class="text-[10px] font-black uppercase tracking-[0.3em] mb-3 opacity-60">Estimated Total</p>
                        <div class="flex items-baseline gap-2">
                            <span class="text-2xl font-bold opacity-80">¥</span>
                            <h2 class="text-5xl font-black">{{ totalExpenses.toLocaleString() }}</h2>
                        </div>
                        <div class="mt-8 pt-8 border-t border-white/10 flex justify-between">
                            <div>
                                <p class="text-[9px] opacity-40 uppercase font-black mb-1">Items</p>
                                <p class="text-sm font-bold">{{ itinerariesCount }} Planned</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] opacity-40 uppercase font-black mb-1">Shopping</p>
                                <p class="text-sm font-bold">{{ shoppingList.length }} Wishes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
        </div>

        <!-- FAB 按鈕 -->
        <button v-if="activeTab !== 'info' && activeTab !== 'expenses'" @click="handleFABClick" 
                class="fixed bottom-10 right-10 w-16 h-16 bg-blue-600 rounded-[28px] flex items-center justify-center text-white shadow-2xl z-50 animate-bounce-slow active:scale-90 transition-transform">
            <i data-lucide="plus" class="w-8 h-8 stroke-[3]"></i>
        </button>

        <!-- 編輯彈窗 -->
        <div v-if="modal.show" class="fixed inset-0 z-[100] flex items-end justify-center bg-slate-900/60 backdrop-blur-md p-4" @click.self="modal.show = false">
            <div class="bg-white w-full max-w-md rounded-t-[56px] p-10 shadow-2xl animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black text-slate-800">{{ modal.title }}</h2>
                    <button @click="modal.show = false" class="p-3 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                
                <div class="space-y-8">
                    <!-- 行程表單 -->
                    <div v-if="!modal.isShopping" class="space-y-6">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block px-1">Location / Event</label>
                            <input v-model="modal.form.name" type="text" class="w-full bg-slate-50 rounded-2xl p-5 font-bold outline-none focus:ring-2 focus:ring-blue-200 border-none" placeholder="Where are we going?">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block px-1">Notes</label>
                            <textarea v-model="modal.form.notes" class="w-full bg-slate-50 rounded-2xl p-5 font-medium h-32 outline-none focus:ring-2 focus:ring-blue-200 border-none" placeholder="Important details..."></textarea>
                        </div>
                    </div>

                    <!-- 購物專用 -->
                    <div v-else class="space-y-6">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block px-1">Product Name</label>
                            <input v-model="modal.form.name" type="text" class="w-full bg-slate-50 rounded-2xl p-5 font-bold outline-none focus:ring-2 focus:ring-blue-200 border-none" placeholder="e.g. Alinamin EX Plus">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block px-1">Price / Place Notes</label>
                            <textarea v-model="modal.form.notes" class="w-full bg-slate-50 rounded-2xl p-5 font-medium h-24 outline-none focus:ring-2 focus:ring-blue-200 border-none" placeholder="Where to buy or how much?"></textarea>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block px-1">Reference Photo</label>
                            <div class="flex items-center gap-6">
                                <div class="w-40 h-40 bg-slate-50 rounded-[40px] border-2 border-dashed border-slate-200 flex items-center justify-center overflow-hidden relative shadow-inner group transition-all active:bg-blue-50">
                                    <img v-if="modal.form.image" :src="modal.form.image" class="w-full h-full object-cover">
                                    <div v-else class="flex flex-col items-center gap-2 opacity-30 group-hover:opacity-60 transition-opacity">
                                        <i data-lucide="camera" class="w-8 h-8 text-blue-500"></i>
                                        <span class="text-[8px] font-black uppercase tracking-[0.2em]">Capture</span>
                                    </div>
                                    <input type="file" accept="image/*" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                                </div>
                                <div v-if="modal.form.image" class="flex flex-col gap-3">
                                    <button @click="modal.form.image = null" class="px-5 py-3 bg-red-50 text-red-500 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 shadow-sm hover:bg-red-100 transition-colors">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Remove
                                    </button>
                                </div>
                                <p v-else class="text-xs text-slate-400 italic leading-relaxed max-w-[120px]">Tap to take a photo or upload product image</p>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按鈕 -->
                    <div class="flex gap-4 pt-4 pb-4">
                        <button v-if="modal.isEdit" @click="handleDelete" class="flex-1 py-5 bg-red-50 text-red-500 font-black rounded-[28px] text-xs uppercase tracking-widest hover:bg-red-100 transition-colors">Delete</button>
                        <button @click="handleSave" class="flex-[3] bg-blue-600 text-white font-black py-5 rounded-[28px] shadow-2xl shadow-blue-200 hover:bg-blue-700 transition-all">
                            {{ modal.isEdit ? 'Update Entry' : 'Add to List' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const selectedDate = ref('1/26');
                const jpyInput = ref(1000);
                const bannerSrc = ref('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1200&q=80');
                
                const weather = ref({ temp: '--', feelsLike: '--', label: 'Locating...', type: 'sun', location: '', time: '--' });
                const weatherLoading = ref(true);
                let sortableInstance = null;

                const tabs = [
                    { id: 'itinerary', icon: 'map-pin' },
                    { id: 'info', icon: 'info' },
                    { id: 'shopping', icon: 'shopping-basket' },
                    { id: 'expenses', icon: 'wallet' }
                ];

                const dates = ['1/26', '1/27', '1/28', '1/29', '1/30', '1/31'];
                const dayLabels = { '1/26': 'SUN', '1/27': 'MON', '1/28': 'TUE', '1/29': 'WED', '1/30': 'THU', '1/31': 'FRI' };

                const flightDetails = [
                    { type: 'DEPARTURE', airline: 'STARLUX', flightNo: 'JX802', depCity: 'TPE (T1)', depTime: '10:10', arrCity: 'NRT (T2)', arrTime: '14:20' },
                    { type: 'RETURN', airline: 'STARLUX', flightNo: 'JX805', depCity: 'NRT (T2)', depTime: '20:10', arrCity: 'TPE (T1)', arrTime: '23:20' }
                ];

                const itineraries = ref({
                    '1/26': [
                        { id: '1-1', name: 'STARLUX JX802', category: '航班', time: '10:10', notes: 'Departing from TPE T1 -> Arrival at NRT T2 at 14:20' },
                        { id: '1-2', name: 'JR East Travel Service Center', category: '交通', notes: 'Pick up Suica & Recharge', transportToNext: { duration: '45 min' } },
                        { id: '1-3', name: 'Keisei Skyliner (To Ueno)', category: '交通', notes: 'Express to Ueno Station', transportToNext: { duration: '15 min' } },
                        { id: '1-4', name: 'Ginza Line Transfer', category: '交通', notes: 'Take to Asakusa (Exit 1)', transportToNext: { duration: '5 min' } },
                        { id: '1-6', name: 'Hop Inn Asakusa Check-in', category: '住宿', time: '16:00', notes: '安置行李與休息', transportToNext: { duration: '10 min' } },
                        { id: '1-7', name: 'UNIQLO Asakusa', category: '購物', notes: 'Open until 20:00', transportToNext: { duration: '10 min' } },
                        { id: '1-9', name: 'Senso-ji Night Walk', category: '景點', notes: 'Night view of Kaminarimon Gate & Lawson snacks' }
                    ],
                    '1/27': [
                        { id: '2-1', name: 'Tokyo Station Character St.', category: '購物', time: '10:00', notes: 'Pokémon Center & Anime shops', transportToNext: { duration: '30 min' } },
                        { id: '2-2', name: 'RED° TOKYO TOWER', category: '景點', time: '15:00', notes: 'Gaming & Virtual experiences', transportToNext: { duration: '40 min' } },
                        { id: '2-3', name: 'Asakusa Local Dinner', category: '美食', time: '19:00', notes: 'Enjoy local Soba or Tempura' }
                    ],
                    '1/28': [
                        { id: '3-1', name: 'Check out & To Ueno', category: '其他', time: '08:00', notes: 'Early morning start', transportToNext: { duration: '70 min' } },
                        { id: '3-2', name: 'Shinkansen (To Yuzawa)', category: '交通', time: '09:58', notes: 'Joetsu Shinkansen to Echigo-Yuzawa', transportToNext: { duration: '73 min' } },
                        { id: '3-3', name: 'Nakanoya Soba', category: '美食', time: '11:30', notes: 'Famous Heishisoba near station', transportToNext: { duration: '45 min' } },
                        { id: '3-5', name: 'Naeba Prince Hotel', category: '住宿', time: '15:30', notes: 'Ski-in Ski-out luxury' }
                    ],
                    '1/29': [{ id: '4-1', name: 'Ski Day 1 (Naeba)', category: '景點', notes: 'Full day on the slopes' }],
                    '1/30': [{ id: '5-1', name: 'Ski Day 2 (Kagura/Naeba)', category: '景點', notes: 'Explore more trails via Dragondola' }],
                    '1/31': [
                        { id: '6-1', name: 'Shuttle Bus to Station', category: '交通', time: '10:15', notes: 'Leaving the snow', transportToNext: { duration: '10 min' } },
                        { id: '6-2', name: 'Tonkatsu Lunch', category: '美食', time: '12:00', notes: 'Crispy pork cutlet', transportToNext: { duration: '67 min' } },
                        { id: '6-3', name: 'Shinkansen back to Tokyo', category: '交通', time: '14:31', notes: 'Heading back to NRT', transportToNext: { duration: '40 min' } },
                        { id: '6-5', name: 'STARLUX JX805', category: '航班', time: '20:10', notes: 'Departing NRT T2 -> Arrival at TPE at 23:20' }
                    ]
                });

                const shoppingList = ref([
                    { id: 1, name: 'Alinamin EX Plus 270', notes: 'Family request (3 bottles)', image: null },
                    { id: 2, name: 'EVE Pain Relief (Blue)', notes: 'Stock up for home', image: null }
                ]);

                const modal = ref({ show: false, title: '', isEdit: false, isShopping: false, form: {} });

                const currentItinerary = computed(() => itineraries.value[selectedDate.value] || []);
                const totalExpenses = computed(() => 125000); // Placeholder
                const itinerariesCount = computed(() => Object.values(itineraries.value).flat().length);

                const handleBannerError = () => {
                    bannerSrc.value = 'https://images.unsplash.com/photo-1540959733332-e94e1bfba1fa?auto=format&fit=crop&w=1200&q=80';
                };

                const fetchWeather = () => {
                    weatherLoading.value = true;
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(async (pos) => {
                            try {
                                const { latitude, longitude } = pos.coords;
                                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`);
                                const data = await res.json();
                                const now = new Date();
                                weather.value = { 
                                    temp: Math.round(data.current_weather.temperature), 
                                    label: data.current_weather.weathercode < 3 ? 'Clear' : 'Cloudy', 
                                    type: data.current_weather.weathercode < 3 ? 'sun' : 'cloud',
                                    location: `GPS (${latitude.toFixed(2)}, ${longitude.toFixed(2)})`,
                                    time: now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0')
                                };
                                weatherLoading.value = false;
                                nextTick(lucide.createIcons);
                            } catch (e) { 
                                weatherLoading.value = false;
                                weather.value.label = 'Weather Error';
                            }
                        }, () => {
                            weather.value.label = 'GPS Denied';
                            weatherLoading.value = false;
                        });
                    }
                };

                const initSortable = () => {
                    const el = document.getElementById('itinerary-list');
                    if (!el || activeTab.value !== 'itinerary') return;
                    if (sortableInstance) sortableInstance.destroy();
                    
                    sortableInstance = new Sortable(el, {
                        animation: 150,
                        handle: '.drag-handle',
                        ghostClass: 'sortable-ghost',
                        dragClass: 'sortable-drag',
                        onEnd: (evt) => {
                            const day = selectedDate.value;
                            const items = [...itineraries.value[day]];
                            const [movedItem] = items.splice(evt.oldIndex, 1);
                            items.splice(evt.newIndex, 0, movedItem);
                            itineraries.value[day] = items;
                            nextTick(() => lucide.createIcons());
                        }
                    });
                };

                const handleImageUpload = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        modal.value.form.image = ev.target.result;
                        nextTick(() => lucide.createIcons());
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                };

                const openEdit = (item) => { 
                    modal.value = { show: true, title: 'Edit Plan', isEdit: true, isShopping: false, form: { ...item } }; 
                    nextTick(lucide.createIcons); 
                };

                const openShoppingEdit = (item) => {
                    modal.value = { show: true, title: 'Edit Wish', isEdit: true, isShopping: true, form: { ...item } };
                    nextTick(lucide.createIcons);
                };

                const handleFABClick = () => { 
                    if (activeTab.value === 'shopping') {
                        modal.value = { show: true, title: 'Add Wish', isEdit: false, isShopping: true, form: { name: '', notes: '', image: null } };
                    } else {
                        modal.value = { show: true, title: 'New Plan', isEdit: false, isShopping: false, form: { name: '', notes: '', category: '景點' } }; 
                    }
                    nextTick(lucide.createIcons); 
                };

                const handleSave = () => {
                    if (modal.value.isShopping) {
                        if (modal.value.isEdit) {
                            const idx = shoppingList.value.findIndex(i => i.id === modal.value.form.id);
                            shoppingList.value[idx] = { ...modal.value.form };
                        } else {
                            shoppingList.value.push({ ...modal.value.form, id: Date.now() });
                        }
                    } else {
                        const day = selectedDate.value;
                        if (modal.value.isEdit) {
                            const idx = itineraries.value[day].findIndex(i => i.id === modal.value.form.id);
                            itineraries.value[day][idx] = { ...modal.value.form };
                        } else {
                            if (!itineraries.value[day]) itineraries.value[day] = [];
                            itineraries.value[day].push({ ...modal.value.form, id: Date.now() });
                        }
                    }
                    modal.value.show = false;
                    nextTick(() => {
                        lucide.createIcons();
                        if (activeTab.value === 'itinerary') initSortable();
                    });
                };

                const handleDelete = () => {
                    if (modal.value.isShopping) {
                        shoppingList.value = shoppingList.value.filter(i => i.id !== modal.value.form.id);
                    } else {
                        const day = selectedDate.value;
                        itineraries.value[day] = itineraries.value[day].filter(i => i.id !== modal.value.form.id);
                    }
                    modal.value.show = false;
                    nextTick(() => lucide.createIcons());
                };

                const navigate = (name) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}`, '_blank');

                watch([selectedDate, activeTab], () => {
                    nextTick(() => {
                        lucide.createIcons();
                        if (activeTab.value === 'itinerary') initSortable();
                    });
                });

                onMounted(() => { 
                    lucide.createIcons(); 
                    fetchWeather();
                    initSortable();
                });

                return { 
                    activeTab, selectedDate, tabs, dates, dayLabels, itineraries, shoppingList, 
                    weather, weatherIcon, weatherLoading, currentItinerary, totalExpenses, modal, jpyInput, flightDetails,
                    bannerSrc, itinerariesCount, handleBannerError, fetchWeather, openEdit, openShoppingEdit, handleSave, handleDelete, 
                    handleFABClick, handleImageUpload, navigate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
